<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>你的前端工程</title>
</head>
<body>
<h2 style="text-align: center">
    用Cookie拿到token，去访问接口
</h2>
<h3 style="text-align: center">
    不同子域名则使用主域的cookie拿token，需要在登录接口修改
</h3>
</body>
</html>


<script language="javascript" type="text/javascript">
    var domain = 'wxauth.garylv.com';
//    var domain = 'wxauth.local.com';
    var token = getCookie("token");
    if (token == '') {
        alert("未登录");
        login();
    } else {
//        alert('token:' + token);
        var url = 'http://' + domain + '/api/v1/users?token=' + token;
        ajax(url);
    }

    function login() {
        window.location.href = "http://" + domain + "/api/v1/wechat_login?url=http%3a%2f%2f" + domain + "%2fwechat";
//        window.location.href = "http://" + domain + "/api/v1/test_login?url=http%3a%2f%2f" + domain + "%2fwechat";
    }

    function getCookie(c_name)
    {
        if (document.cookie.length>0)
        {
            c_start=document.cookie.indexOf(c_name + "=")
            if (c_start!=-1)
            {
                c_start=c_start + c_name.length+1
                c_end=document.cookie.indexOf(";",c_start)
                if (c_end==-1) c_end=document.cookie.length
                return unescape(document.cookie.substring(c_start,c_end))
            }
        }
        return ""
    }

    function ajax(url) {

        //先声明一个异步请求对象
        var xmlHttpReg = null;
        if (window.ActiveXObject) {//如果是IE

            xmlHttpReg = new ActiveXObject("Microsoft.XMLHTTP");

        } else if (window.XMLHttpRequest) {

            xmlHttpReg = new XMLHttpRequest(); //实例化一个xmlHttpReg
        }

        //如果实例化成功,就调用open()方法,就开始准备向服务器发送请求
        if (xmlHttpReg != null) {
            xmlHttpReg.open("get", url, true);
            xmlHttpReg.send(null);
            xmlHttpReg.onreadystatechange = doResult; //设置回调函数

        }

        //回调函数
        //一旦readyState的值改变,将会调用这个函数,readyState=4表示完成相应

        //设定函数doResult()
        function doResult() {

            if (xmlHttpReg.readyState == 4) {//4代表执行完成


                if (xmlHttpReg.status == 200) {//200代表执行成功
                    //将xmlHttpReg.responseText的值赋给ID为resText的元素
                    var result = JSON.parse(xmlHttpReg.responseText);
                    var success = result.success;
                    if (success == false && result.code == 2002) {
//                        token失效
                        login();
                    } else {
                        alert('欢迎访问, ' + result.data.nickname)
                    }
                }
            }

        }


    }
</script>
